**Overview**
- **Purpose**: Concise record of changes made to enable automatic n8n workflow import, the rationale, and how to operate and troubleshoot the importer.
- **Scope**: Node-based entrypoint importer, Docker artifacts moved to `docker/`, `.env` centralization, modular workflows added while preserving the monolith.

**Files Changed**
- **`docker/entrypoint.js`**: Canonical NodeJS entrypoint that spawns n8n, waits for the API to be ready, attempts REST updates, falls back to the `n8n` CLI import, and watches `~/.n8n/workflows` for JSON changes to re-import.
- **`docker/Dockerfile`**: Updated to `COPY entrypoint.js /usr/local/bin/entrypoint.js` and set the container ENTRYPOINT to run the Node script.
- **`workflows/`**: Added modular workflow JSONs (`01-telegram-ingest.json`, `02-process-message.json`, `03-generate-and-reply.json`) and preserved `telegram-multi-agent-bot.json` (the original monolithic workflow).
- **`.env` / `.env.example`**: Centralized environment variables including `N8N_BASIC_AUTH_*`, `POSTGRES_*`, `GEMINI_*`, `DEEPSEEK_*`, `LLM_PROVIDER`, `LLM_MODEL`, and runtime vars like `N8N_RUNNERS_ENABLED`, `TZ`.
- **`docs/AI_ASSISTED_DEVELOPMENT.md`**: This file — step-by-step notes and instructions.

**Entrypoint Behavior**
- **Start**: The entrypoint spawns the upstream `n8n` process and forwards signals.
- **Wait-for-ready**: Polls `GET /rest/workflows` until the API responds. The script pragmatically treats an HTTP `200` or `401` as "ready" because the REST endpoint sometimes returns `401` inside the container even when Basic Auth envs are present.
- **Import Strategy**:
  - For each `*.json` file in `~/.n8n/workflows`, the script first attempts a REST `PUT` update by workflow name.
  - If REST update fails (or is unavailable due to auth), the script falls back to the CLI: `n8n import:workflow --input <file>`.
  - The importer is deliberately import-only: it does not automatically activate workflows. Activation is left to the user or an explicit process.
- **Watcher**: A debounced `fs.watch` monitors the workflows directory and re-runs the import pass on changes.

**Why Node Entrypoint?**
- The official n8n image lacks a usable shell for a simple shell entrypoint that can orchestrate REST probes + CLI fallback reliably. A small Node script inside the container provides precise control and better cross-platform behavior inside Docker.

**How to Build & Run**
- Build the custom image (from project root):
  - ``docker-compose -f .\docker-compose.yml build n8n``
- Start or restart the service:
  - ``docker-compose -f .\docker-compose.yml up -d n8n``
- View logs (to watch importer actions):
  - ``docker-compose -f .\docker-compose.yml logs --tail 200 n8n``

**How to Add or Update Workflows**
- Place or edit JSON files in the repository `workflows/` (they are copied into the container at runtime via volume). The entrypoint's watcher will detect changes and re-import automatically.
- The importer will not auto-activate workflows. To activate a workflow manually:
  - Use the n8n Editor UI to toggle activation.
  - Or use the REST API with appropriate credentials to patch `workflow.active` to `true` for the target workflow id.

**Troubleshooting Notes**
- REST `401` inside container: Observed behavior where `GET /rest/workflows` returned `401` despite Basic Auth envs being set. The entrypoint treats `401` as "ready" and uses CLI fallback.
- If CLI imports succeed but workflows appear inactive: this is expected. Activation is explicit and intentionally omitted to avoid surprising runtime behavior.
- If the watcher doesn't pick changes: confirm the workflows directory is correctly mounted and that JSON files have `.json` extension (no `.imported_*` marker files are used).

**Operation Checklist**
- Ensure `.env` contains correct values and secrets.
- Build image: ``docker-compose -f .\docker-compose.yml build n8n``
- Start container: ``docker-compose -f .\docker-compose.yml up -d n8n``
- Check logs and verify messages like `Successfully imported 1 workflow.` and `File watcher established`.

**Notes & Rationale**
- Idempotency: The importer is idempotent at import time (it will re-import files repeatedly). This is simpler and safer than touching the database to toggle activation, and it preserves the user's stated preference to keep the monolith and modular workflows without silent overwrites.
- Activation is intentionally manual to avoid accidental live behavior changes during automated deployments.

**Next Steps (optional)**
- If you want automatic activation, we can add an explicit opt-in step that either:
  - Uses the REST API with a reliable auth path to activate workflows after import, or
  - Uses a DB migration (Postgres) to toggle `workflow_entity.active` (more invasive — use with caution).

**Contact**
- For follow-ups, mention this file and the `docker/entrypoint.js` script when asking about importer behavior or making further changes.

---
Generated by the AI-assisted development session that implemented the importer and workflow modularization.
**AI-Assisted Development Log**

This file documents the changes made during an AI-assisted editing session. It is intended as a concise record for maintainers and auditors. Sensitive values (API keys, tokens, passwords) are not included here — they remain in the local `./.env` and should not be committed.

**Summary**
- **Session date**: 2025-11-14
- **Scope**: Docker Compose / environment variables / n8n workflow updates / cleanup of local Dockerfile / documentation updates

**Files Added / Modified / Removed**
- **Updated**: `docker-compose.yml`
  - Replaced inline `environment:` blocks for `postgres` and `n8n` with `env_file: - .env` to centralize configuration.
  - Switched the `n8n` service from a local build to the official image: `image: n8nio/n8n:1.120.2`.
  - Kept `depends_on`, `volumes`, `ports`, and `healthcheck` as before.

- **Added**: `./.env`
  - Created a single environment file that contains runtime variables and placeholders for secrets (Postgres, n8n, Telegram tokens, OpenAI/Gemini/Deepseek credentials, LLM provider selection, fallback provider/model, n8n runtime flags, timezone and NODE_ENV).
  - IMPORTANT: This file contains secrets for local development. Do not commit it to source control; add it to `.gitignore`.

- **Updated**: `./.env.example`
  - Expanded to document all environment variables used by the compose setup, including `POSTGRES_*`, `DB_*`, `N8N_*`, `TELEGRAM_BOT_TOKEN_*`, `OPENAI_API_KEY`, and provider-specific variables (`GEMINI_*`, `DEEPSEEK_*`), `LLM_PROVIDER`, `LLM_MODEL`, and fallback variables.

- **Updated**: `docs/QUICKSTART.md`
  - Replaced prior minimal env instructions with updated guidance to copy `./.env.example` to `.env`, fill provider keys, and the new LLM provider/fallback options.

- **Removed**: `Dockerfile`
  - The local `Dockerfile` was removed from the project because the compose file uses the official image now.
  - The deletion was committed locally using the repository's inferred GitHub identity.

- **Updated**: `workflows/telegram-multi-agent-bot.json`
  - Added a new `Code` node named **Set LLM Provider Info** which attaches `llm_provider`, `llm_model`, and fallback fields from environment variables to each item.
  - Updated the `LLM Generate Response` node to use the environment model: `={{$env.LLM_MODEL}}` instead of a hard-coded model string.
  - Updated the `Store Agent Response` SQL to record the model used via `{{$env.LLM_MODEL}}`.
  - Routed the flow so conversation context goes through `Set LLM Provider Info` before calling the LLM node.

- **Removed**: `Dockerfile` commit
  - A local commit was made removing the Dockerfile (not pushed to remote).

**New environment variables introduced**
- `LLM_PROVIDER`, `LLM_MODEL` — choose provider and model (e.g., `openai`, `gemini`, `deepseek`).
- `GEMINI_API_KEY`, `GEMINI_API_BASE` — optional Gemini credentials.
- `DEEPSEEK_API_KEY`, `DEEPSEEK_API_BASE` — optional Deepseek credentials.
- `FALLBACK_LLM_PROVIDER`, `FALLBACK_LLM_MODEL` — provider/model to try when the primary fails.
- `N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS`, `N8N_RUNNERS_ENABLED`, `NODE_ENV`, `GENERIC_TIMEZONE`, `TZ` — n8n runtime flags and timezone settings.

**Commands run during session**
- `docker-compose -f .\docker-compose.yml config` — validate merged compose config several times.
- `docker-compose -f .\docker-compose.yml up -d` — started services locally (as requested earlier in the session).
- `git remote get-url origin` — infer GitHub username for local commit identity.
- `git config user.name "<inferred>"` and `git config user.email "<inferred>@users.noreply.github.com"` — set local git identity for this repository.
- `git rm -f Dockerfile` and `git commit -m "chore: remove local Dockerfile (use official n8n image)"` — remove Dockerfile and commit deletion locally.

**Validation & Notes**
- `docker-compose config` reported a warning that the `version` field is deprecated. Consider removing the `version: '3.8'` line from `docker-compose.yml` to silence the warning.
- The `.env` file now contains secret values (tokens, API keys). Add `.env` to `.gitignore` if you haven't already.
- I did not push commits to remote; confirm if you want me to push them.

**Recommended next steps**
- Add `.env` to `.gitignore` to avoid committing secrets.
- Remove the deprecated `version` line from `docker-compose.yml`.
- Implement runtime provider-fallback logic in the n8n workflow:
  - Option A: Use a `Code` or HTTP node that attempts the primary provider and, on failure, calls the fallback provider using provider-specific env vars. This is the most flexible path.
  - Option B: Create separate provider nodes (OpenAI/Gemini/Deepseek) and use conditional branching based on `LLM_PROVIDER`.
- Optionally add `docker-compose.override.yml` for local development that sets `build: .` to use a local Dockerfile when needed (keeping the main compose file referencing the stable image for production).

**Where to look**
- `docker-compose.yml` — main compose definition (now uses `env_file` and official n8n image).
- `./.env` — local runtime environment (contains secrets; not to be committed).
- `./.env.example` — template and documentation of env vars.
`docs/QUICKSTART.md` — updated setup instructions.
- `workflows/telegram-multi-agent-bot.json` — workflow changes for LLM provider/fallback flags.

If you want, I can:
- Add `.env` to `.gitignore` now and commit that change.
- Remove the `version` line from `docker-compose.yml`.
- Implement the provider-fallback logic inside the n8n workflow (Code + HTTP nodes) and test the flow.

---

*This summary was generated and added to the repository during an AI-assisted editing session.*
---

### 2025-11-14  AI Append: docs reorganization & cleanup (preserve history)

- Moved top-level documentation files into `docs/` and updated internal references:
  - `ARCHITECTURE.md`, `QUICKSTART.md`, `TROUBLESHOOTING.md`, and this file were moved to `docs/`.
  - Updated `docs/AI_ASSISTED_DEVELOPMENT.md` to reference `docs/QUICKSTART.md`.

- Updated `README.md`:
  - Added a **Documentation** section linking the moved docs under `docs/`.
  - Added a **License** section pointing to `LICENSE` and noting GPLv3.

- Inspected `scripts/import-and-run.sh`:
  - Located a POSIX shell import script at `scripts/import-and-run.sh`.
  - Performed a repo-wide search: there are no references to this script in the codebase.
  - Attempted removal via git earlier but the removal was not committed; the file remains on disk.
  - I did not delete the file without explicit confirmation. If you want it removed I can delete the file from disk and/or run `git rm` and commit the removal.

This entry is appended to preserve the full history of AI-assisted edits. I will not modify earlier entries  only append new ones as requested.


### 2025-11-14  AI Append: docs reorganization & cleanup (preserve history)

- Moved top-level documentation files into `docs/` and updated internal references:
  - `ARCHITECTURE.md`, `QUICKSTART.md`, `TROUBLESHOOTING.md`, and this file were moved to `docs/`.
  - Updated `docs/AI_ASSISTED_DEVELOPMENT.md` to reference `docs/QUICKSTART.md`.

- Updated `README.md`:
  - Added a **Documentation** section linking the moved docs under `docs/`.
  - Added a **License** section pointing to `LICENSE` and noting GPLv3.

- Inspected `scripts/import-and-run.sh`:
  - Located a POSIX shell import script at `scripts/import-and-run.sh`.
  - Performed a repo-wide search: there are no references to this script in the codebase.
  - Attempted removal via git earlier but the removal was not committed; the file remains on disk.
  - I did not delete the file without explicit confirmation. If you want it removed I can delete the file from disk and/or run `git rm` and commit the removal.

This entry is appended to preserve the full history of AI-assisted edits. I will not modify earlier entries  only append new ones as requested.

---

### 2025-11-14  AI Append: moved docker files, removed compose version, and commit

- Removed top-level `version` key from `docker-compose.yml` to silence the compose deprecation warning.
- Created `docker/` and moved `Dockerfile`, `entrypoint.js`, and `init.sql` into it; updated `docker-compose.yml` to use `./docker/init.sql` and `build: ./docker`.
- Removed root copies of the moved files.
- Validated `docker-compose` config; services reported: `postgres`, `n8n`.
- Appended this entry to `docs/AI_ASSISTED_DEVELOPMENT.md` and committed changes locally. The branch is ahead of `origin/main` by one commit; run `git push origin main` to publish.

---

### 2025-11-15  AI Append: Enhanced workflow import system and environment variable cleanup

**Session scope**: Improved automatic workflow import/replace on startup, enhanced logging, and centralized environment configuration.

**Files Modified**:

- **`docker-compose.yml`**:
  - Added `user: "node"` to n8n service for proper file permissions
  - Removed inline `environment:` block (moved vars to `.env`)
  - Added volume mount for entrypoint script: `./docker/entrypoint.js:/usr/local/bin/entrypoint.js`
  - Set `working_dir: /home/node/.n8n`
  - Configured custom entrypoint: `["node", "/usr/local/bin/entrypoint.js"]`
  - Added healthcheck for n8n service using `/rest/healthz` endpoint
  - All environment variables now loaded exclusively from `.env` file

- **`docker/entrypoint.js`**:
  - Complete rewrite of logging system with structured log levels (DEBUG, INFO, WARN, ERROR)
  - Added timestamps to all log messages for better debugging
  - Enhanced workflow import logic:
    - Better error handling with specific error messages
    - Improved REST API workflow update with detailed status reporting
    - More reliable CLI fallback mechanism
    - Success/failure counting and reporting
    - Visual indicators (✓ and ✗) for operation status
  - Improved file watcher with better debouncing (1 second delay)
  - Added comprehensive startup banner with clear status messages
  - Better process lifecycle management with graceful shutdown

- **`.env.example`**:
  - Updated `N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS` from `true` to `false` (prevents Docker volume permission issues)
  - Added `N8N_DIAGNOSTICS_ENABLED=true` for enhanced error logging
  - Added `N8N_DEFAULT_BINARY_DATA_MODE=filesystem` for proper file handling
  - Added explanatory comments for each new variable

**Key Improvements**:

1. **Automatic Workflow Import on Startup**:
   - n8n now automatically imports/replaces all workflows in the `workflows/` folder when the container starts
   - Workflows are first updated via REST API if they already exist (preserving workflow IDs)
   - Falls back to CLI import for new workflows or if REST fails
   - Detailed logging shows which workflows succeeded/failed

2. **Live Reload**:
   - File watcher detects changes to workflow JSON files
   - Automatically re-imports modified workflows without container restart
   - 1-second debounce prevents multiple rapid imports

3. **Better Logging**:
   - Structured log levels with timestamps
   - Clear visual feedback (✓/✗) for operations
   - Progress reporting during import process
   - Startup banner shows system status clearly

4. **Environment Variable Cleanup**:
   - All configuration centralized in `.env` file
   - No hardcoded environment variables in `docker-compose.yml`
   - Cleaner separation of concerns

**Operation**:
- Place workflow JSON files in `workflows/` directory
- Start container: `docker-compose up -d`
- Watch logs: `docker-compose logs -f n8n`
- Workflows are automatically imported and updated on startup
- Any changes to workflow files trigger automatic re-import

**Troubleshooting**:
- Check logs for detailed import status and error messages
- Look for lines with ✓ (success) or ✗ (failure) indicators
- If REST API fails, the system automatically falls back to CLI import
- All errors include specific file paths and error messages

**Created Documentation**:
- `AGENTS.md` — detailed documentation of the three AI agents (Alpha, Beta, Gamma) including personalities, system prompts, and customization instructions (moved to root folder for prominence)


